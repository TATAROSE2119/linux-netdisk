<!DOCTYPE html>
<html>
<head>
    <title>简易网页版网盘Demo</title>
</head>
<body>
<h2>注册/登录</h2>
用户名 <input id="user"><br>
密码 <input id="pass" type="password"><br>
<button onclick="register()">注册</button>
<button onclick="login()">登录</button>
<h2>上传文件</h2>
<input type="file" id="file">
<button onclick="upload()">上传</button>
<progress id="uploadProgress" value="0" max="100" style="width: 100%; display: none;"></progress>
<span id="uploadSpeed" style="display: none;">上传速度: 0 MB/s</span>
<h2>文件列表</h2>
<ul id="filelist"></ul>
<script>
let curUser = "";

function register() {
    fetch('/api/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: user.value, password: pass.value})
    }).then(r=>r.json()).then(j=>alert(j.ok ? "注册成功" : j.msg));
}
function login() {
    fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: user.value, password: pass.value})
    }).then(r=>r.json()).then(j=>{
        if(j.ok){
            curUser = user.value;
            alert("登录成功");
            listFiles();
        }else{
            alert(j.msg);
        }
    });
}
async function upload() {
    if(!curUser){ alert("请先登录"); return; }
    let fileInput = document.getElementById('file');
    let file = fileInput.files[0];
    if (!file) { alert("未选择文件"); return; }
    let progress = document.getElementById('uploadProgress');
    let speedElem = document.getElementById('uploadSpeed');
    progress.style.display = 'block';
    speedElem.style.display = 'block';
    progress.value = 0;
    speedElem.innerText = '上传速度: 0 MB/s';

    const chunkSize = 10 * 1024 * 1024; // 10MB
    const totalChunks = Math.ceil(file.size / chunkSize);
    let uploadedChunks = 0;
    let totalUploadedBytes = 0;
    let startTime = Date.now();

    for (let i = 0; i < totalChunks; i++) {
        let chunkStartTime = Date.now();
        let start = i * chunkSize;
        let end = Math.min(file.size, start + chunkSize);
        let chunk = file.slice(start, end);

    let formData = new FormData();
    formData.append('username', curUser);
        formData.append('file', chunk);
        formData.append('filename', file.name);
        formData.append('chunkIndex', i);
        formData.append('totalChunks', totalChunks);

        try {
            let response = await fetch('/api/upload_chunk', {method: 'POST', body: formData});
            let j = await response.json();
            if (!j.ok) throw new Error(j.msg);
            uploadedChunks++;
            totalUploadedBytes += chunk.size;
            progress.value = (uploadedChunks / totalChunks) * 100;

            let chunkTime = (Date.now() - chunkStartTime) / 1000; // 秒
            let chunkSpeed = (chunk.size / chunkTime / 1024 / 1024).toFixed(2); // MB/s
            speedElem.innerText = `上传速度: ${chunkSpeed} MB/s`;
        } catch (e) {
            progress.style.display = 'none';
            speedElem.style.display = 'none';
            alert("分片上传失败: " + e.message);
            return;
        }
    }

    // 合并分片
    try {
        let mergeResponse = await fetch('/api/merge_chunks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: curUser, filename: file.name, totalChunks})
        });
        let mergeJ = await mergeResponse.json();
        if (mergeJ.ok) {
            let totalTime = (Date.now() - startTime) / 1000; // 秒
            let avgSpeed = (file.size / totalTime / 1024 / 1024).toFixed(2); // MB/s
            alert(`上传成功！平均速度: ${avgSpeed} MB/s`);
            listFiles();
        } else {
            alert("合并失败: " + mergeJ.msg);
        }
    } catch (e) {
        alert("合并请求失败: " + e.message);
    }
    progress.style.display = 'none';
    speedElem.style.display = 'none';
}
function listFiles() {
    fetch('/api/list?username='+encodeURIComponent(curUser))
      .then(r=>r.json()).then(j=>{
          let ul = document.getElementById('filelist');
          ul.innerHTML = '';
          j.files.forEach(f=>{
              let li = document.createElement('li');
              li.innerHTML = `${f} <button onclick="downloadFile('${f}')">下载</button> <button onclick="renameFile('${f}')">改名</button> <button onclick="deleteFile('${f}')">删除</button>`;
              ul.appendChild(li);
          });
      });
}
function downloadFile(filename) {
    if(!curUser){ alert("请先登录"); return; }
    window.location.href = `/api/download?username=${encodeURIComponent(curUser)}&filename=${encodeURIComponent(filename)}`;
}
function renameFile(old_filename) {
    if(!curUser){ alert("请先登录"); return; }
    let new_filename = prompt("请输入新文件名:", old_filename);
    if(!new_filename || new_filename === old_filename) return;
    fetch('/api/rename', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: curUser, old_filename: old_filename, new_filename: new_filename})
    }).then(r=>r.json()).then(j=>{
        if(j.ok){ alert("改名成功"); listFiles(); }
        else alert(j.msg);
    });
}
function deleteFile(filename) {
    if(!curUser){ alert("请先登录"); return; }
    fetch('/api/delete', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username: curUser, filename: filename})
    }).then(r=>r.json()).then(j=>{
        if(j.ok){ alert("删除成功"); listFiles(); }
        else alert(j.msg);
      });
}
</script>
</body>
</html>
