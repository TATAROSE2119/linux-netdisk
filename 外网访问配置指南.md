# 🌐 macOS 网盘外网访问配置指南

## 📋 外网访问方式对比

| 方式 | 难度 | 稳定性 | 速度 | 费用 | 适用场景 |
|------|------|--------|------|------|----------|
| 🌉 Cloudflare隧道 | ⭐ | ⭐⭐⭐ | ⭐⭐ | 免费 | 临时访问，快速分享 |
| 🔗 Ngrok隧道 | ⭐ | ⭐⭐ | ⭐⭐ | 免费/付费 | 开发测试，临时访问 |
| 🏠 路由器端口转发 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 免费 | 长期使用，家庭网络 |
| 🦆 DuckDNS动态域名 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | 免费 | 动态IP环境 |

## 🚀 快速开始

### 方法一：一键外网访问（推荐）
```bash
# 启动本地服务 + Cloudflare隧道
./start_external_macos.sh
```

### 方法二：配置向导
```bash
# 交互式配置外网访问
./setup_external_access_macos.sh
```

### 方法三：手动配置
```bash
# 1. 启动本地服务
./start_all_macos.sh

# 2. 在新终端启动隧道
cd gui_examples
./start_external_access.sh
```

## 🌉 Cloudflare 隧道（推荐）

### 优点
- ✅ 完全免费
- ✅ 无需配置路由器
- ✅ 自动HTTPS加密
- ✅ 全球CDN加速
- ✅ 一键启动

### 缺点
- ❌ URL是临时的
- ❌ 重启后URL会变
- ❌ 依赖网络连接

### 使用方法
```bash
# 一键启动（包含本地服务）
./start_external_macos.sh

# 或者单独启动隧道
cd gui_examples
./start_external_access.sh
```

## 🔗 Ngrok 隧道

### 安装 Ngrok
```bash
# 使用 Homebrew 安装
brew install ngrok/ngrok/ngrok

# 注册账号并获取认证令牌
ngrok config add-authtoken <your-token>
```

### 使用方法
```bash
# 启动本地服务
./start_all_macos.sh

# 在新终端启动 Ngrok
ngrok http 8080
```

## 🏠 路由器端口转发

### 配置步骤

1. **获取本机IP地址**
```bash
# 查看本机IP
ipconfig getifaddr en0
```

2. **登录路由器管理界面**
   - 通常是 `192.168.1.1` 或 `192.168.0.1`
   - 使用管理员账号登录

3. **配置端口转发规则**
   - 外部端口：`8080` → 内部IP：`你的Mac IP:8080`
   - 外部端口：`9000` → 内部IP：`你的Mac IP:9000`

4. **获取公网IP**
```bash
# 查看公网IP
curl https://api.ipify.org
```

5. **访问地址**
   - Web界面：`http://你的公网IP:8080`

### 注意事项
- ⚠️ 需要固定本机IP（DHCP保留）
- ⚠️ 路由器需要支持端口转发
- ⚠️ 运营商不能屏蔽相关端口

## 🦆 DuckDNS 动态域名

### 配置步骤

1. **注册 DuckDNS 账号**
   - 访问：https://www.duckdns.org
   - 使用GitHub/Google账号登录

2. **创建域名**
   - 选择一个子域名，如：`yourname.duckdns.org`
   - 获取Token

3. **更新配置文件**
```bash
# 编辑配置
vim gui_examples/api/config.py

# 修改以下内容
DOMAIN_NAME = 'yourname.duckdns.org'
DUCKDNS_DOMAIN = 'yourname'
DUCKDNS_TOKEN = 'your-token-here'
```

4. **启动服务**
```bash
./start_all_macos.sh
```

5. **更新IP地址**
```bash
cd gui_examples
python3 update_duckdns.py
```

## 🔧 网络配置检查

### 检查本机网络
```bash
# 查看网络状态
./setup_external_access_macos.sh
# 选择选项 5

# 手动检查
ipconfig getifaddr en0  # 本机IP
curl https://api.ipify.org  # 公网IP
lsof -i :8080  # 端口占用
```

### 检查防火墙设置
```bash
# macOS 防火墙状态
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 允许应用通过防火墙
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /path/to/your/app
```

## 🛡️ 安全建议

### 基本安全措施
1. **使用强密码**
   - 网盘账户使用复杂密码
   - 定期更换密码

2. **限制访问时间**
   - 临时访问完成后及时关闭隧道
   - 不要长期开放外网访问

3. **监控访问日志**
   - 定期检查访问记录
   - 发现异常及时处理

4. **网络隔离**
   - 考虑使用专用网络
   - 避免与重要设备在同一网段

### 高级安全配置
```bash
# 配置HTTPS（可选）
# 需要SSL证书，适合长期使用

# 配置访问控制
# 在路由器或防火墙中设置IP白名单
```

## 🔍 故障排除

### 常见问题

1. **隧道无法启动**
```bash
# 检查网络连接
ping 8.8.8.8

# 检查端口占用
lsof -i :8080

# 重新下载客户端
rm gui_examples/cloudflared-darwin-amd64
./start_external_macos.sh
```

2. **无法访问Web界面**
```bash
# 检查服务状态
curl http://localhost:8080

# 重启服务
./stop_all_macos.sh
./start_all_macos.sh
```

3. **路由器端口转发不生效**
- 检查路由器配置是否正确
- 确认本机IP是否变化
- 检查运营商是否屏蔽端口

### 日志查看
```bash
# 查看服务日志
tail -f server/server.log  # 如果有日志文件

# 查看系统日志
log show --predicate 'process == "server"' --last 1h
```

## 📞 技术支持

如果遇到问题：

1. **检查环境**：运行 `./test_deployment_macos.sh`
2. **查看网络状态**：运行 `./setup_external_access_macos.sh` 选择选项5
3. **重启服务**：`./stop_all_macos.sh && ./start_all_macos.sh`
4. **检查防火墙**：确保相关端口未被阻止

## 🎯 最佳实践

1. **临时访问**：使用 Cloudflare 隧道
2. **长期使用**：配置路由器端口转发 + DuckDNS
3. **开发测试**：使用 Ngrok
4. **安全第一**：定期更新密码，监控访问日志
