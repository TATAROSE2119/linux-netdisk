<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç›˜å®¢æˆ·ç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .login-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .login-form {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-weight: bold;
            color: #495057;
        }
        
        .form-group input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .toolbar {
            padding: 20px;
            background: #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .file-area {
            padding: 20px;
            min-height: 400px;
        }
        
        .file-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .file-list th,
        .file-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .file-list th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        
        .file-list tr:hover {
            background: #f8f9fa;
        }
        
        .file-list tr.selected {
            background: #e3f2fd;
        }
        
        .status-bar {
            padding: 15px 20px;
            background: #343a40;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-bar {
            width: 200px;
            height: 20px;
            background: #6c757d;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }
        
        .hidden {
            display: none;
        }
        
        .file-icon {
            margin-right: 8px;
        }
        
        .upload-area {
            border: 2px dashed #ced4da;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ ç½‘ç›˜å®¢æˆ·ç«¯</h1>
            <p>å®‰å…¨ã€å¿«é€Ÿçš„æ–‡ä»¶å­˜å‚¨ä¸åˆ†äº«</p>
        </div>
        
        <div class="login-section">
            <div class="login-form">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
                <button class="btn btn-info" onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-success" onclick="uploadFile()" disabled id="uploadBtn">
                ğŸ“¤ ä¸Šä¼ æ–‡ä»¶
            </button>
            <button class="btn btn-success" onclick="batchUpload()" disabled id="batchUploadBtn">
                ğŸ“¤ æ‰¹é‡ä¸Šä¼ 
            </button>
            <button class="btn btn-primary" onclick="downloadFile()" disabled id="downloadBtn">
                ğŸ“¥ ä¸‹è½½æ–‡ä»¶
            </button>
            <button class="btn btn-success" onclick="downloadSelected()" disabled id="batchDownloadBtn">
                ğŸ“¦ æ‰¹é‡ä¸‹è½½
            </button>
            <button class="btn btn-danger" onclick="deleteItem()" disabled id="deleteBtn">
                ğŸ—‘ï¸ åˆ é™¤
            </button>
            <button class="btn btn-info" onclick="createFolder()" disabled id="createFolderBtn">
                ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹
            </button>
            <button class="btn btn-info" onclick="renameItem()" disabled id="renameBtn">
                âœï¸ é‡å‘½å
            </button>
            <button class="btn btn-info" onclick="refreshList()" disabled id="refreshBtn">
                ğŸ”„ åˆ·æ–°åˆ—è¡¨
            </button>
            <button class="btn btn-info" onclick="selectAll()" disabled id="selectAllBtn">
                â˜‘ï¸ å…¨é€‰
            </button>
            <button class="btn btn-info" onclick="clearSelection()" disabled id="clearSelectionBtn">
                âŒ å–æ¶ˆé€‰æ‹©
            </button>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
        </div>
        
        <div class="file-area">
            <!-- è·¯å¾„å¯¼èˆªæ  -->
            <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <button class="btn btn-info" onclick="goToParentDir()" id="backBtn" disabled>
                    â¬…ï¸ è¿”å›ä¸Šçº§
                </button>
                <span style="font-weight: bold;">ğŸ“ å½“å‰ä½ç½®:</span>
                <span id="currentPathDisplay" style="font-family: monospace; background: white; padding: 5px 10px; border-radius: 3px;">/</span>
            </div>

            <div class="upload-area" id="uploadArea">
                <h3>ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </h3>
                <p>æˆ–ç‚¹å‡»ä¸Šä¼ æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                <p style="color: #6c757d; font-size: 14px;">å°†ä¸Šä¼ åˆ°: <span id="uploadPathDisplay">/</span></p>
            </div>
            
            <table class="file-list" id="fileList">
                <thead>
                    <tr>
                        <th>â˜‘ï¸ é€‰æ‹©</th>
                        <th>ğŸ“„ åç§°</th>
                        <th>ğŸ“‚ ç±»å‹</th>
                        <th>ğŸ“Š å¤§å°</th>
                        <th>ğŸ“… ä¿®æ”¹æ—¶é—´</th>
                        <th>âš™ï¸ æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="fileTableBody">
                    <!-- æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <div class="status-bar">
            <span id="statusText">å°±ç»ª</span>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- æ‰¹é‡ä¸Šä¼ é˜Ÿåˆ—æ˜¾ç¤º -->
        <div id="uploadQueueContainer" style="display: none; margin: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="margin-top: 0;">ğŸ“¤ ä¸Šä¼ é˜Ÿåˆ—</h4>
            <div id="uploadQueue"></div>
            <div style="margin-top: 10px;">
                <button class="btn btn-danger" onclick="clearUploadQueue()" id="clearQueueBtn">ğŸ—‘ï¸ æ¸…ç©ºé˜Ÿåˆ—</button>
                <button class="btn btn-warning" onclick="pauseUpload()" id="pauseBtn" style="display: none;">â¸ï¸ æš‚åœ</button>
                <button class="btn btn-success" onclick="resumeUpload()" id="resumeBtn" style="display: none;">â–¶ï¸ ç»§ç»­</button>
                <span id="queueStatus" style="margin-left: 15px; font-weight: bold;"></span>
            </div>
        </div>
    </div>

    <script>
        let isLoggedIn = false;
        let currentUser = '';
        let selectedFile = null;
        let selectedFiles = new Set();  // å¤šé€‰æ–‡ä»¶é›†åˆ
        let currentPath = '/';  // å½“å‰ç›®å½•è·¯å¾„

        // æ‰¹é‡ä¸Šä¼ ç›¸å…³å˜é‡
        let uploadQueue = [];  // ä¸Šä¼ é˜Ÿåˆ—
        let isUploading = false;  // æ˜¯å¦æ­£åœ¨ä¸Šä¼ 
        let isPaused = false;  // æ˜¯å¦æš‚åœ
        let currentUploadIndex = 0;  // å½“å‰ä¸Šä¼ ç´¢å¼•
        
        // ç™»å½•åŠŸèƒ½
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            setStatus('æ­£åœ¨ç™»å½•...');

            // å°è¯•è¿æ¥åˆ°Webæ¡¥æ¥æœåŠ¡å™¨
            fetch('http://localhost:5000/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isLoggedIn = true;
                    currentUser = username;
                    setStatus('ç™»å½•æˆåŠŸ - å·²è¿æ¥åˆ°CæœåŠ¡å™¨');
                    enableButtons();
                    refreshList();
                } else {
                    setStatus('ç™»å½•å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.log('æ— æ³•è¿æ¥åˆ°CæœåŠ¡å™¨ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼:', error);
                // å›é€€åˆ°æ¼”ç¤ºæ¨¡å¼
                isLoggedIn = true;
                currentUser = username;
                setStatus('ç™»å½•æˆåŠŸ (æ¼”ç¤ºæ¨¡å¼ - CæœåŠ¡å™¨æœªå¯åŠ¨)');
                enableButtons();
                loadDemoFiles();
            });
        }
        
        // æ³¨å†ŒåŠŸèƒ½
        function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            setStatus('æ­£åœ¨æ³¨å†Œ...');

            // å°è¯•è¿æ¥åˆ°Webæ¡¥æ¥æœåŠ¡å™¨
            fetch('http://localhost:5000/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                } else {
                    setStatus('æ³¨å†Œå¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.log('æ— æ³•è¿æ¥åˆ°CæœåŠ¡å™¨ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼:', error);
                setStatus('æ³¨å†ŒæˆåŠŸ (æ¼”ç¤ºæ¨¡å¼)ï¼Œè¯·ç™»å½•');
            });
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        function uploadFile() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            document.getElementById('fileInput').click();
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                uploadFileToServer(file);
            }
        }
        
        // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
        function uploadFileToServer(file) {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            setStatus('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: ' + file.name);
            setProgress(0);

            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('file', file);
            formData.append('username', currentUser);
            formData.append('targetPath', currentPath);

            // å°è¯•ä¸Šä¼ åˆ°çœŸå®æœåŠ¡å™¨
            fetch('http://localhost:5000/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ' + file.name);
                    setProgress(100);
                    setTimeout(() => {
                        setProgress(0);
                        refreshList();
                    }, 1000);
                } else {
                    setStatus('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + data.message);
                    setProgress(0);
                }
            })
            .catch(error => {
                console.log('ä¸Šä¼ å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼:', error);
                // å›é€€åˆ°æ¼”ç¤ºæ¨¡å¼
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    setProgress(progress);
                    if (progress >= 100) {
                        clearInterval(interval);
                        setStatus('æ–‡ä»¶ä¸Šä¼ å®Œæˆ (æ¼”ç¤ºæ¨¡å¼)');
                        setProgress(0);
                        refreshList();
                    }
                }, 200);
            });
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile() {
            if (!selectedFile) {
                alert('è¯·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©çš„æ˜¯æ–‡ä»¶å¤¹
            const selectedRow = document.querySelector('#fileTableBody tr.selected');
            if (selectedRow) {
                const typeCell = selectedRow.cells[2]; // æ³¨æ„ï¼šç°åœ¨ç±»å‹åˆ—æ˜¯ç¬¬3åˆ—ï¼ˆç´¢å¼•2ï¼‰
                if (typeCell && typeCell.textContent === 'æ–‡ä»¶å¤¹') {
                    alert('ä¸èƒ½ä¸‹è½½æ–‡ä»¶å¤¹ï¼Œè¯·é€‰æ‹©æ–‡ä»¶');
                    return;
                }
            }

            downloadSingleFile(selectedFile);
        }
        
        // åˆ é™¤æ–‡ä»¶
        function deleteFile() {
            if (!selectedFile) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "' + selectedFile + '" å—ï¼Ÿ')) {
                setStatus('æ­£åœ¨åˆ é™¤æ–‡ä»¶: ' + selectedFile);
                
                // TODO: å®ç°æ–‡ä»¶åˆ é™¤
                setTimeout(() => {
                    setStatus('æ–‡ä»¶åˆ é™¤å®Œæˆ');
                    refreshList();
                }, 1000);
            }
        }
        
        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        function refreshList() {
            if (!isLoggedIn) return;

            setStatus('æ­£åœ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨...');

            // å°è¯•ä»çœŸå®æœåŠ¡å™¨è·å–æ–‡ä»¶åˆ—è¡¨
            fetch(`http://localhost:5000/api/files?username=${encodeURIComponent(currentUser)}&path=${encodeURIComponent(currentPath)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRealFiles(data.files);
                    setStatus('æ–‡ä»¶åˆ—è¡¨åˆ·æ–°å®Œæˆ');
                } else {
                    setStatus('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + data.message);
                    loadDemoFiles(); // å›é€€åˆ°æ¼”ç¤ºæ•°æ®
                }
            })
            .catch(error => {
                console.log('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®:', error);
                loadDemoFiles();
                setStatus('æ–‡ä»¶åˆ—è¡¨åˆ·æ–°å®Œæˆ (æ¼”ç¤ºæ¨¡å¼)');
            });
        }
        
        // åŠ è½½çœŸå®æ–‡ä»¶åˆ—è¡¨
        function loadRealFiles(files) {
            const tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = '';

            if (files.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #6c757d; padding: 40px;">
                        ğŸ“ æš‚æ— æ–‡ä»¶ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶
                    </td>
                `;
                return;
            }

            files.forEach(file => {
                const row = tbody.insertRow();

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const formatSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                    return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
                };

                // æ ¼å¼åŒ–æ—¶é—´
                const formatTime = (timestamp) => {
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString('zh-CN');
                };

                const isDirectory = file.type === 'directory';
                const icon = isDirectory ? 'ğŸ“' : 'ğŸ“„';
                const typeText = isDirectory ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶';
                const sizeText = isDirectory ? '-' : formatSize(file.size);

                row.innerHTML = `
                    <td>
                        <input type="checkbox" onchange="toggleFileSelection('${file.name}', this.checked)"
                               ${isDirectory ? 'disabled title="æ–‡ä»¶å¤¹ä¸æ”¯æŒæ‰¹é‡ä¸‹è½½"' : ''}>
                    </td>
                    <td>
                        <span class="file-icon">${icon}</span>
                        ${isDirectory ?
                            `<a href="javascript:void(0)" onclick="enterFolder('${file.name}')" style="text-decoration: none; color: #007bff;">${file.name}</a>` :
                            file.name
                        }
                    </td>
                    <td>${typeText}</td>
                    <td>${sizeText}</td>
                    <td>${formatTime(file.mtime)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="selectItem('${file.name}', ${isDirectory})">é€‰æ‹©</button>
                        ${isDirectory ?
                            `<button class="btn btn-info" onclick="enterFolder('${file.name}')" style="margin-left: 5px;">è¿›å…¥</button>` :
                            ''
                        }
                    </td>
                `;
            });
        }

        // åŠ è½½æ¼”ç¤ºæ–‡ä»¶
        function loadDemoFiles() {
            const files = [
                { name: 'document.txt', size: '1.2 KB', time: '2024-01-15 10:30' },
                { name: 'photo.jpg', size: '2.5 MB', time: '2024-01-14 15:45' },
                { name: 'video.mp4', size: '15.8 MB', time: '2024-01-13 09:20' },
                { name: 'presentation.pptx', size: '5.3 MB', time: '2024-01-12 14:15' }
            ];
            
            const tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = '';
            
            files.forEach(file => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="file-icon">ğŸ“„</span>${file.name}</td>
                    <td>${file.size}</td>
                    <td>${file.time}</td>
                    <td>
                        <button class="btn btn-primary" onclick="selectFile('${file.name}')">é€‰æ‹©</button>
                    </td>
                `;
            });
        }
        
        // é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
        function selectItem(name, isDirectory) {
            selectedFile = name;

            // é«˜äº®é€‰ä¸­çš„è¡Œ
            const rows = document.querySelectorAll('#fileTableBody tr');
            rows.forEach(row => row.classList.remove('selected'));
            event.target.closest('tr').classList.add('selected');

            const type = isDirectory ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶';
            setStatus(`å·²é€‰æ‹©${type}: ${name}`);
        }

        // è¿›å…¥æ–‡ä»¶å¤¹
        function enterFolder(folderName) {
            if (currentPath === '/') {
                currentPath = '/' + folderName;
            } else {
                currentPath = currentPath + '/' + folderName;
            }
            updatePathDisplay();
            refreshList();
        }

        // è¿”å›ä¸Šçº§ç›®å½•
        function goToParentDir() {
            if (currentPath === '/') return;

            const lastSlash = currentPath.lastIndexOf('/');
            if (lastSlash === 0) {
                currentPath = '/';
            } else {
                currentPath = currentPath.substring(0, lastSlash);
            }
            updatePathDisplay();
            refreshList();
        }

        // æ–°å»ºæ–‡ä»¶å¤¹
        function createFolder() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const folderName = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:');
            if (!folderName || folderName.trim() === '') {
                return;
            }

            const trimmedName = folderName.trim();
            if (trimmedName.includes('/') || trimmedName.includes('\\')) {
                alert('æ–‡ä»¶å¤¹åç§°ä¸èƒ½åŒ…å« / æˆ– \\ å­—ç¬¦');
                return;
            }

            setStatus('æ­£åœ¨åˆ›å»ºæ–‡ä»¶å¤¹: ' + trimmedName);

            const folderPath = currentPath === '/' ? '/' + trimmedName : currentPath + '/' + trimmedName;

            fetch('http://localhost:5000/api/mkdir', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    path: folderPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ: ' + trimmedName);
                    refreshList();
                } else {
                    setStatus('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.log('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥:', error);
                setStatus('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥ (ç½‘ç»œé”™è¯¯)');
            });
        }

        // é‡å‘½åæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
        function renameItem() {
            if (!selectedFile) {
                alert('è¯·å…ˆé€‰æ‹©è¦é‡å‘½åçš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
                return;
            }

            const newName = prompt('è¯·è¾“å…¥æ–°åç§°:', selectedFile);
            if (!newName || newName.trim() === '' || newName.trim() === selectedFile) {
                return;
            }

            const trimmedName = newName.trim();
            if (trimmedName.includes('/') || trimmedName.includes('\\')) {
                alert('åç§°ä¸èƒ½åŒ…å« / æˆ– \\ å­—ç¬¦');
                return;
            }

            setStatus('æ­£åœ¨é‡å‘½å: ' + selectedFile + ' -> ' + trimmedName);

            // æ„å»ºæ—§è·¯å¾„å’Œæ–°è·¯å¾„
            const oldPath = currentPath === '/' ? '/' + selectedFile : currentPath + '/' + selectedFile;
            const newPath = currentPath === '/' ? '/' + trimmedName : currentPath + '/' + trimmedName;

            fetch('http://localhost:5000/api/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    oldPath: oldPath,
                    newPath: newPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('é‡å‘½åæˆåŠŸ: ' + selectedFile + ' -> ' + trimmedName);
                    selectedFile = null;
                    refreshList();
                } else {
                    setStatus('é‡å‘½åå¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.log('é‡å‘½åå¤±è´¥:', error);
                setStatus('é‡å‘½åå¤±è´¥ (ç½‘ç»œé”™è¯¯)');
            });
        }

        // åˆ é™¤æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
        function deleteItem() {
            if (!selectedFile) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${selectedFile}" å—ï¼Ÿ`)) {
                return;
            }

            setStatus('æ­£åœ¨åˆ é™¤: ' + selectedFile);

            const itemPath = currentPath === '/' ? '/' + selectedFile : currentPath + '/' + selectedFile;

            fetch('http://localhost:5000/api/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    path: itemPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('åˆ é™¤æˆåŠŸ: ' + selectedFile);
                    selectedFile = null;
                    refreshList();
                } else {
                    setStatus('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.log('åˆ é™¤å¤±è´¥:', error);
                setStatus('åˆ é™¤å¤±è´¥ (ç½‘ç»œé”™è¯¯)');
            });
        }
        
        // å¯ç”¨æŒ‰é’®
        function enableButtons() {
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('batchUploadBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('batchDownloadBtn').disabled = false;
            document.getElementById('deleteBtn').disabled = false;
            document.getElementById('createFolderBtn').disabled = false;
            document.getElementById('renameBtn').disabled = false;
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('selectAllBtn').disabled = false;
            document.getElementById('clearSelectionBtn').disabled = false;
            updateNavigationButtons();
        }

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            document.getElementById('backBtn').disabled = currentPath === '/';
        }

        // æ›´æ–°è·¯å¾„æ˜¾ç¤º
        function updatePathDisplay() {
            document.getElementById('currentPathDisplay').textContent = currentPath;
            document.getElementById('uploadPathDisplay').textContent = currentPath;
            updateNavigationButtons();
        }
        
        // è®¾ç½®çŠ¶æ€æ–‡æœ¬
        function setStatus(text) {
            document.getElementById('statusText').textContent = text;
        }
        
        // è®¾ç½®è¿›åº¦æ¡
        function setProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // åˆ‡æ¢æ–‡ä»¶é€‰æ‹©çŠ¶æ€
        function toggleFileSelection(filename, isSelected) {
            if (isSelected) {
                selectedFiles.add(filename);
            } else {
                selectedFiles.delete(filename);
            }
            updateSelectionStatus();
        }

        // å…¨é€‰æ–‡ä»¶
        function selectAll() {
            const checkboxes = document.querySelectorAll('#fileTableBody input[type="checkbox"]:not([disabled])');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const filename = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                selectedFiles.add(filename);
            });
            updateSelectionStatus();
        }

        // å–æ¶ˆæ‰€æœ‰é€‰æ‹©
        function clearSelection() {
            const checkboxes = document.querySelectorAll('#fileTableBody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedFiles.clear();
            updateSelectionStatus();
        }

        // æ›´æ–°é€‰æ‹©çŠ¶æ€æ˜¾ç¤º
        function updateSelectionStatus() {
            const count = selectedFiles.size;
            if (count > 0) {
                setStatus(`å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶`);
                document.getElementById('batchDownloadBtn').style.background = '#28a745';
                document.getElementById('batchDownloadBtn').textContent = `ğŸ“¦ æ‰¹é‡ä¸‹è½½ (${count})`;
            } else {
                document.getElementById('batchDownloadBtn').style.background = '#6c757d';
                document.getElementById('batchDownloadBtn').textContent = 'ğŸ“¦ æ‰¹é‡ä¸‹è½½';
            }
        }

        // æ‰¹é‡ä¸‹è½½é€‰ä¸­çš„æ–‡ä»¶
        function downloadSelected() {
            if (selectedFiles.size === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }

            if (selectedFiles.size === 1) {
                // å¦‚æœåªé€‰æ‹©äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œç›´æ¥ä¸‹è½½
                const filename = Array.from(selectedFiles)[0];
                downloadSingleFile(filename);
                return;
            }

            setStatus(`æ­£åœ¨æ‰“åŒ…ä¸‹è½½ ${selectedFiles.size} ä¸ªæ–‡ä»¶...`);
            setProgress(0);

            // æ„å»ºæ–‡ä»¶è·¯å¾„åˆ—è¡¨
            const filePaths = Array.from(selectedFiles).map(filename => {
                return currentPath === '/' ? '/' + filename : currentPath + '/' + filename;
            });

            // å‘é€æ‰¹é‡ä¸‹è½½è¯·æ±‚
            fetch('http://localhost:5000/api/batch-download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    filePaths: filePaths,
                    zipName: `files_${new Date().getTime()}.zip`
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || 'æ‰¹é‡ä¸‹è½½å¤±è´¥');
                    });
                }
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `selected_files_${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                setStatus(`æ‰¹é‡ä¸‹è½½å®Œæˆ: ${selectedFiles.size} ä¸ªæ–‡ä»¶`);
                setProgress(100);
                setTimeout(() => setProgress(0), 2000);

                // æ¸…é™¤é€‰æ‹©
                clearSelection();
            })
            .catch(error => {
                console.log('æ‰¹é‡ä¸‹è½½å¤±è´¥:', error);
                setStatus('æ‰¹é‡ä¸‹è½½å¤±è´¥: ' + error.message);
                setProgress(0);
            });
        }

        // ä¸‹è½½å•ä¸ªæ–‡ä»¶ï¼ˆä»åŸæœ‰å‡½æ•°ä¸­æå–ï¼‰
        function downloadSingleFile(filename) {
            setStatus('æ­£åœ¨ä¸‹è½½æ–‡ä»¶: ' + filename);
            setProgress(0);

            // æ„å»ºæ–‡ä»¶è·¯å¾„
            const filePath = currentPath === '/' ? '/' + filename : currentPath + '/' + filename;

            // åˆ›å»ºä¸‹è½½è¯·æ±‚
            fetch('http://localhost:5000/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    filePath: filePath
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || 'ä¸‹è½½å¤±è´¥');
                    });
                }
            })
            .then(blob => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                setStatus('æ–‡ä»¶ä¸‹è½½å®Œæˆ: ' + filename);
                setProgress(100);
                setTimeout(() => setProgress(0), 2000);
            })
            .catch(error => {
                console.log('ä¸‹è½½å¤±è´¥:', error);
                setStatus('ä¸‹è½½å¤±è´¥: ' + error.message);
                setProgress(0);
            });
        }
        
        // æ‰¹é‡ä¸Šä¼ åŠŸèƒ½
        function batchUpload() {
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨ï¼Œæ”¯æŒå¤šé€‰
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;  // æ”¯æŒå¤šé€‰
            input.accept = '*/*';   // æ¥å—æ‰€æœ‰æ–‡ä»¶ç±»å‹

            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    addFilesToQueue(files);
                }
            };

            input.click();
        }

        // æ·»åŠ æ–‡ä»¶åˆ°ä¸Šä¼ é˜Ÿåˆ—
        function addFilesToQueue(files) {
            files.forEach((file, index) => {
                const queueItem = {
                    id: Date.now() + index,
                    file: file,
                    status: 'waiting',  // waiting, uploading, completed, failed, paused
                    progress: 0,
                    error: null
                };
                uploadQueue.push(queueItem);
            });

            updateQueueDisplay();
            showUploadQueue();

            // å¦‚æœæ²¡æœ‰æ­£åœ¨ä¸Šä¼ ï¼Œå¼€å§‹ä¸Šä¼ 
            if (!isUploading) {
                startBatchUpload();
            }
        }

        // æ˜¾ç¤ºä¸Šä¼ é˜Ÿåˆ—
        function showUploadQueue() {
            document.getElementById('uploadQueueContainer').style.display = 'block';
        }

        // éšè—ä¸Šä¼ é˜Ÿåˆ—
        function hideUploadQueue() {
            document.getElementById('uploadQueueContainer').style.display = 'none';
        }

        // æ›´æ–°é˜Ÿåˆ—æ˜¾ç¤º
        function updateQueueDisplay() {
            const queueContainer = document.getElementById('uploadQueue');
            queueContainer.innerHTML = '';

            if (uploadQueue.length === 0) {
                queueContainer.innerHTML = '<p style="color: #6c757d;">é˜Ÿåˆ—ä¸ºç©º</p>';
                return;
            }

            uploadQueue.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'margin: 10px 0; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white;';

                const statusIcon = getStatusIcon(item.status);
                const statusColor = getStatusColor(item.status);

                itemDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${item.file.name}</strong>
                            <span style="color: #6c757d; margin-left: 10px;">(${formatFileSize(item.file.size)})</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="color: ${statusColor}; margin-right: 10px;">${statusIcon} ${getStatusText(item.status)}</span>
                            ${item.status === 'waiting' || item.status === 'failed' ?
                                `<button class="btn btn-danger" onclick="removeFromQueue(${item.id})" style="padding: 2px 8px; font-size: 12px;">ç§»é™¤</button>` :
                                ''
                            }
                        </div>
                    </div>
                    ${item.status === 'uploading' ?
                        `<div style="margin-top: 5px;">
                            <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: #007bff; width: ${item.progress}%; transition: width 0.3s;"></div>
                            </div>
                            <small style="color: #6c757d;">${item.progress}%</small>
                        </div>` :
                        ''
                    }
                    ${item.error ? `<div style="color: #dc3545; font-size: 12px; margin-top: 5px;">é”™è¯¯: ${item.error}</div>` : ''}
                `;

                queueContainer.appendChild(itemDiv);
            });

            updateQueueStatus();
        }

        // è·å–çŠ¶æ€å›¾æ ‡
        function getStatusIcon(status) {
            switch(status) {
                case 'waiting': return 'â³';
                case 'uploading': return 'ğŸ“¤';
                case 'completed': return 'âœ…';
                case 'failed': return 'âŒ';
                case 'paused': return 'â¸ï¸';
                default: return 'â“';
            }
        }

        // è·å–çŠ¶æ€é¢œè‰²
        function getStatusColor(status) {
            switch(status) {
                case 'waiting': return '#6c757d';
                case 'uploading': return '#007bff';
                case 'completed': return '#28a745';
                case 'failed': return '#dc3545';
                case 'paused': return '#ffc107';
                default: return '#6c757d';
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch(status) {
                case 'waiting': return 'ç­‰å¾…ä¸­';
                case 'uploading': return 'ä¸Šä¼ ä¸­';
                case 'completed': return 'å·²å®Œæˆ';
                case 'failed': return 'å¤±è´¥';
                case 'paused': return 'å·²æš‚åœ';
                default: return 'æœªçŸ¥';
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ›´æ–°é˜Ÿåˆ—çŠ¶æ€
        function updateQueueStatus() {
            const total = uploadQueue.length;
            const completed = uploadQueue.filter(item => item.status === 'completed').length;
            const failed = uploadQueue.filter(item => item.status === 'failed').length;
            const uploading = uploadQueue.filter(item => item.status === 'uploading').length;

            const statusText = `æ€»è®¡: ${total} | å·²å®Œæˆ: ${completed} | å¤±è´¥: ${failed} | ä¸Šä¼ ä¸­: ${uploading}`;
            document.getElementById('queueStatus').textContent = statusText;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');

            if (isUploading && !isPaused) {
                pauseBtn.style.display = 'inline-block';
                resumeBtn.style.display = 'none';
            } else if (isPaused) {
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'inline-block';
            } else {
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
            }
        }

        // ä»é˜Ÿåˆ—ä¸­ç§»é™¤æ–‡ä»¶
        function removeFromQueue(itemId) {
            uploadQueue = uploadQueue.filter(item => item.id !== itemId);
            updateQueueDisplay();

            if (uploadQueue.length === 0) {
                hideUploadQueue();
                isUploading = false;
                isPaused = false;
                currentUploadIndex = 0;
            }
        }

        // æ¸…ç©ºä¸Šä¼ é˜Ÿåˆ—
        function clearUploadQueue() {
            if (isUploading && !isPaused) {
                if (!confirm('æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œç¡®å®šè¦æ¸…ç©ºé˜Ÿåˆ—å—ï¼Ÿ')) {
                    return;
                }
            }

            uploadQueue = [];
            isUploading = false;
            isPaused = false;
            currentUploadIndex = 0;
            updateQueueDisplay();
            hideUploadQueue();
            setStatus('ä¸Šä¼ é˜Ÿåˆ—å·²æ¸…ç©º');
        }

        // æš‚åœä¸Šä¼ 
        function pauseUpload() {
            isPaused = true;
            updateQueueDisplay();
            setStatus('ä¸Šä¼ å·²æš‚åœ');
        }

        // ç»§ç»­ä¸Šä¼ 
        function resumeUpload() {
            isPaused = false;
            updateQueueDisplay();
            setStatus('ä¸Šä¼ å·²ç»§ç»­');

            if (!isUploading) {
                startBatchUpload();
            }
        }

        // å¼€å§‹æ‰¹é‡ä¸Šä¼ 
        function startBatchUpload() {
            if (uploadQueue.length === 0 || isPaused) {
                return;
            }

            isUploading = true;
            updateQueueDisplay();

            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªç­‰å¾…ä¸Šä¼ çš„æ–‡ä»¶
            const nextItem = uploadQueue.find(item => item.status === 'waiting');
            if (!nextItem) {
                // æ²¡æœ‰ç­‰å¾…ä¸Šä¼ çš„æ–‡ä»¶ï¼Œä¸Šä¼ å®Œæˆ
                isUploading = false;
                setStatus('æ‰¹é‡ä¸Šä¼ å®Œæˆ');
                updateQueueDisplay();

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ–‡ä»¶éƒ½ä¸Šä¼ å®Œæˆ
                const allCompleted = uploadQueue.every(item => item.status === 'completed' || item.status === 'failed');
                if (allCompleted) {
                    setTimeout(() => {
                        refreshList();
                    }, 1000);
                }
                return;
            }

            // å¼€å§‹ä¸Šä¼ å½“å‰æ–‡ä»¶
            uploadSingleFileFromQueue(nextItem);
        }

        // ä»é˜Ÿåˆ—ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        function uploadSingleFileFromQueue(queueItem) {
            if (isPaused) {
                return;
            }

            queueItem.status = 'uploading';
            queueItem.progress = 0;
            updateQueueDisplay();

            setStatus(`æ­£åœ¨ä¸Šä¼ : ${queueItem.file.name}`);

            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('file', queueItem.file);
            formData.append('username', currentUser);
            formData.append('path', currentPath);

            // å‘é€ä¸Šä¼ è¯·æ±‚
            fetch('http://localhost:5000/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    queueItem.status = 'completed';
                    queueItem.progress = 100;
                    setStatus(`ä¸Šä¼ æˆåŠŸ: ${queueItem.file.name}`);
                } else {
                    queueItem.status = 'failed';
                    queueItem.error = data.message;
                    setStatus(`ä¸Šä¼ å¤±è´¥: ${queueItem.file.name}`);
                }

                updateQueueDisplay();

                // ç»§ç»­ä¸Šä¼ ä¸‹ä¸€ä¸ªæ–‡ä»¶
                setTimeout(() => {
                    startBatchUpload();
                }, 500);
            })
            .catch(error => {
                console.log('ä¸Šä¼ å¤±è´¥:', error);
                queueItem.status = 'failed';
                queueItem.error = error.message;
                updateQueueDisplay();

                // ç»§ç»­ä¸Šä¼ ä¸‹ä¸€ä¸ªæ–‡ä»¶
                setTimeout(() => {
                    startBatchUpload();
                }, 500);
            });
        }

        // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (!isLoggedIn) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                if (files.length === 1) {
                    // å•ä¸ªæ–‡ä»¶ç›´æ¥ä¸Šä¼ 
                    uploadFileToServer(files[0]);
                } else {
                    // å¤šä¸ªæ–‡ä»¶æ·»åŠ åˆ°æ‰¹é‡ä¸Šä¼ é˜Ÿåˆ—
                    addFilesToQueue(files);
                }
            }
        });
    </script>
</body>
</html>
