<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网盘客户端</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .login-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .login-form {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-group label {
            font-weight: bold;
            color: #495057;
        }
        
        .form-group input {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .toolbar {
            padding: 20px;
            background: #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .file-area {
            padding: 20px;
            min-height: 400px;
        }
        
        .file-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .file-list th,
        .file-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .file-list th {
            background: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        
        .file-list tr:hover {
            background: #f8f9fa;
        }
        
        .file-list tr.selected {
            background: #e3f2fd;
        }
        
        .status-bar {
            padding: 15px 20px;
            background: #343a40;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-bar {
            width: 200px;
            height: 20px;
            background: #6c757d;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }
        
        .hidden {
            display: none;
        }
        
        .file-icon {
            margin-right: 8px;
        }
        
        .upload-area {
            border: 2px dashed #ced4da;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌐 网盘客户端</h1>
            <p>安全、快速的文件存储与分享</p>
        </div>
        
        <div class="login-section">
            <div class="login-form">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" placeholder="请输入密码">
                </div>
                <button class="btn btn-primary" onclick="login()">登录</button>
                <button class="btn btn-info" onclick="register()">注册</button>
            </div>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-success" onclick="uploadFile()" disabled id="uploadBtn">
                📤 上传文件
            </button>
            <button class="btn btn-success" onclick="batchUpload()" disabled id="batchUploadBtn">
                📤 批量上传
            </button>
            <button class="btn btn-primary" onclick="downloadFile()" disabled id="downloadBtn">
                📥 下载文件
            </button>
            <button class="btn btn-success" onclick="downloadSelected()" disabled id="batchDownloadBtn">
                📦 批量下载
            </button>
            <button class="btn btn-danger" onclick="deleteItem()" disabled id="deleteBtn">
                🗑️ 删除
            </button>
            <button class="btn btn-info" onclick="createFolder()" disabled id="createFolderBtn">
                📁 新建文件夹
            </button>
            <button class="btn btn-info" onclick="renameItem()" disabled id="renameBtn">
                ✏️ 重命名
            </button>
            <button class="btn btn-info" onclick="refreshList()" disabled id="refreshBtn">
                🔄 刷新列表
            </button>
            <button class="btn btn-info" onclick="selectAll()" disabled id="selectAllBtn">
                ☑️ 全选
            </button>
            <button class="btn btn-info" onclick="clearSelection()" disabled id="clearSelectionBtn">
                ❌ 取消选择
            </button>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
        </div>
        
        <div class="file-area">
            <!-- 路径导航栏 -->
            <div style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <button class="btn btn-info" onclick="goToParentDir()" id="backBtn" disabled>
                    ⬅️ 返回上级
                </button>
                <span style="font-weight: bold;">📍 当前位置:</span>
                <span id="currentPathDisplay" style="font-family: monospace; background: white; padding: 5px 10px; border-radius: 3px;">/</span>
            </div>

            <div class="upload-area" id="uploadArea">
                <h3>📁 拖拽文件到此处上传</h3>
                <p>或点击上传按钮选择文件</p>
                <p style="color: #6c757d; font-size: 14px;">将上传到: <span id="uploadPathDisplay">/</span></p>
            </div>
            
            <table class="file-list" id="fileList">
                <thead>
                    <tr>
                        <th>☑️ 选择</th>
                        <th>📄 名称</th>
                        <th>📂 类型</th>
                        <th>📊 大小</th>
                        <th>📅 修改时间</th>
                        <th>⚙️ 操作</th>
                    </tr>
                </thead>
                <tbody id="fileTableBody">
                    <!-- 文件列表将在这里动态生成 -->
                </tbody>
            </table>
        </div>
        
        <div class="status-bar">
            <span id="statusText">就绪</span>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- 批量上传队列显示 -->
        <div id="uploadQueueContainer" style="display: none; margin: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="margin-top: 0;">📤 上传队列</h4>
            <div id="uploadQueue"></div>
            <div style="margin-top: 10px;">
                <button class="btn btn-danger" onclick="clearUploadQueue()" id="clearQueueBtn">🗑️ 清空队列</button>
                <button class="btn btn-warning" onclick="pauseUpload()" id="pauseBtn" style="display: none;">⏸️ 暂停</button>
                <button class="btn btn-success" onclick="resumeUpload()" id="resumeBtn" style="display: none;">▶️ 继续</button>
                <span id="queueStatus" style="margin-left: 15px; font-weight: bold;"></span>
            </div>
        </div>
    </div>

    <script>
        let isLoggedIn = false;
        let currentUser = '';
        let selectedFile = null;
        let selectedFiles = new Set();  // 多选文件集合
        let currentPath = '/';  // 当前目录路径

        // 批量上传相关变量
        let uploadQueue = [];  // 上传队列
        let isUploading = false;  // 是否正在上传
        let isPaused = false;  // 是否暂停
        let currentUploadIndex = 0;  // 当前上传索引
        
        // 登录功能
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }

            setStatus('正在登录...');

            // 尝试连接到Web桥接服务器
            fetch('http://localhost:5000/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    isLoggedIn = true;
                    currentUser = username;
                    setStatus('登录成功 - 已连接到C服务器');
                    enableButtons();
                    refreshList();
                } else {
                    setStatus('登录失败: ' + data.message);
                }
            })
            .catch(error => {
                console.log('无法连接到C服务器，使用演示模式:', error);
                // 回退到演示模式
                isLoggedIn = true;
                currentUser = username;
                setStatus('登录成功 (演示模式 - C服务器未启动)');
                enableButtons();
                loadDemoFiles();
            });
        }
        
        // 注册功能
        function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                alert('请输入用户名和密码');
                return;
            }

            setStatus('正在注册...');

            // 尝试连接到Web桥接服务器
            fetch('http://localhost:5000/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('注册成功，请登录');
                } else {
                    setStatus('注册失败: ' + data.message);
                }
            })
            .catch(error => {
                console.log('无法连接到C服务器，使用演示模式:', error);
                setStatus('注册成功 (演示模式)，请登录');
            });
        }
        
        // 上传文件
        function uploadFile() {
            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }
            document.getElementById('fileInput').click();
        }
        
        // 处理文件选择
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                uploadFileToServer(file);
            }
        }
        
        // 上传文件到服务器
        function uploadFileToServer(file) {
            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }

            setStatus('正在上传文件: ' + file.name);
            setProgress(0);

            // 创建FormData对象
            const formData = new FormData();
            formData.append('file', file);
            formData.append('username', currentUser);
            formData.append('targetPath', currentPath);

            // 尝试上传到真实服务器
            fetch('http://localhost:5000/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('文件上传成功: ' + file.name);
                    setProgress(100);
                    setTimeout(() => {
                        setProgress(0);
                        refreshList();
                    }, 1000);
                } else {
                    setStatus('文件上传失败: ' + data.message);
                    setProgress(0);
                }
            })
            .catch(error => {
                console.log('上传失败，使用演示模式:', error);
                // 回退到演示模式
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    setProgress(progress);
                    if (progress >= 100) {
                        clearInterval(interval);
                        setStatus('文件上传完成 (演示模式)');
                        setProgress(0);
                        refreshList();
                    }
                }, 200);
            });
        }
        
        // 下载文件
        function downloadFile() {
            if (!selectedFile) {
                alert('请选择要下载的文件');
                return;
            }

            // 检查是否选择的是文件夹
            const selectedRow = document.querySelector('#fileTableBody tr.selected');
            if (selectedRow) {
                const typeCell = selectedRow.cells[2]; // 注意：现在类型列是第3列（索引2）
                if (typeCell && typeCell.textContent === '文件夹') {
                    alert('不能下载文件夹，请选择文件');
                    return;
                }
            }

            downloadSingleFile(selectedFile);
        }
        
        // 删除文件
        function deleteFile() {
            if (!selectedFile) {
                alert('请选择要删除的文件');
                return;
            }
            
            if (confirm('确定要删除文件 "' + selectedFile + '" 吗？')) {
                setStatus('正在删除文件: ' + selectedFile);
                
                // TODO: 实现文件删除
                setTimeout(() => {
                    setStatus('文件删除完成');
                    refreshList();
                }, 1000);
            }
        }
        
        // 刷新文件列表
        function refreshList() {
            if (!isLoggedIn) return;

            setStatus('正在刷新文件列表...');

            // 尝试从真实服务器获取文件列表
            fetch(`http://localhost:5000/api/files?username=${encodeURIComponent(currentUser)}&path=${encodeURIComponent(currentPath)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRealFiles(data.files);
                    setStatus('文件列表刷新完成');
                } else {
                    setStatus('获取文件列表失败: ' + data.message);
                    loadDemoFiles(); // 回退到演示数据
                }
            })
            .catch(error => {
                console.log('无法连接到服务器，使用演示数据:', error);
                loadDemoFiles();
                setStatus('文件列表刷新完成 (演示模式)');
            });
        }
        
        // 加载真实文件列表
        function loadRealFiles(files) {
            const tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = '';

            if (files.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #6c757d; padding: 40px;">
                        📁 暂无文件，请上传文件
                    </td>
                `;
                return;
            }

            files.forEach(file => {
                const row = tbody.insertRow();

                // 格式化文件大小
                const formatSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                    return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
                };

                // 格式化时间
                const formatTime = (timestamp) => {
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleString('zh-CN');
                };

                const isDirectory = file.type === 'directory';
                const icon = isDirectory ? '📁' : '📄';
                const typeText = isDirectory ? '文件夹' : '文件';
                const sizeText = isDirectory ? '-' : formatSize(file.size);

                row.innerHTML = `
                    <td>
                        <input type="checkbox" onchange="toggleFileSelection('${file.name}', this.checked)"
                               ${isDirectory ? 'disabled title="文件夹不支持批量下载"' : ''}>
                    </td>
                    <td>
                        <span class="file-icon">${icon}</span>
                        ${isDirectory ?
                            `<a href="javascript:void(0)" onclick="enterFolder('${file.name}')" style="text-decoration: none; color: #007bff;">${file.name}</a>` :
                            file.name
                        }
                    </td>
                    <td>${typeText}</td>
                    <td>${sizeText}</td>
                    <td>${formatTime(file.mtime)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="selectItem('${file.name}', ${isDirectory})">选择</button>
                        ${isDirectory ?
                            `<button class="btn btn-info" onclick="enterFolder('${file.name}')" style="margin-left: 5px;">进入</button>` :
                            ''
                        }
                    </td>
                `;
            });
        }

        // 加载演示文件
        function loadDemoFiles() {
            const files = [
                { name: 'document.txt', size: '1.2 KB', time: '2024-01-15 10:30' },
                { name: 'photo.jpg', size: '2.5 MB', time: '2024-01-14 15:45' },
                { name: 'video.mp4', size: '15.8 MB', time: '2024-01-13 09:20' },
                { name: 'presentation.pptx', size: '5.3 MB', time: '2024-01-12 14:15' }
            ];
            
            const tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = '';
            
            files.forEach(file => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="file-icon">📄</span>${file.name}</td>
                    <td>${file.size}</td>
                    <td>${file.time}</td>
                    <td>
                        <button class="btn btn-primary" onclick="selectFile('${file.name}')">选择</button>
                    </td>
                `;
            });
        }
        
        // 选择文件或文件夹
        function selectItem(name, isDirectory) {
            selectedFile = name;

            // 高亮选中的行
            const rows = document.querySelectorAll('#fileTableBody tr');
            rows.forEach(row => row.classList.remove('selected'));
            event.target.closest('tr').classList.add('selected');

            const type = isDirectory ? '文件夹' : '文件';
            setStatus(`已选择${type}: ${name}`);
        }

        // 进入文件夹
        function enterFolder(folderName) {
            if (currentPath === '/') {
                currentPath = '/' + folderName;
            } else {
                currentPath = currentPath + '/' + folderName;
            }
            updatePathDisplay();
            refreshList();
        }

        // 返回上级目录
        function goToParentDir() {
            if (currentPath === '/') return;

            const lastSlash = currentPath.lastIndexOf('/');
            if (lastSlash === 0) {
                currentPath = '/';
            } else {
                currentPath = currentPath.substring(0, lastSlash);
            }
            updatePathDisplay();
            refreshList();
        }

        // 新建文件夹
        function createFolder() {
            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }

            const folderName = prompt('请输入文件夹名称:');
            if (!folderName || folderName.trim() === '') {
                return;
            }

            const trimmedName = folderName.trim();
            if (trimmedName.includes('/') || trimmedName.includes('\\')) {
                alert('文件夹名称不能包含 / 或 \\ 字符');
                return;
            }

            setStatus('正在创建文件夹: ' + trimmedName);

            const folderPath = currentPath === '/' ? '/' + trimmedName : currentPath + '/' + trimmedName;

            fetch('http://localhost:5000/api/mkdir', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    path: folderPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('文件夹创建成功: ' + trimmedName);
                    refreshList();
                } else {
                    setStatus('文件夹创建失败: ' + data.message);
                }
            })
            .catch(error => {
                console.log('创建文件夹失败:', error);
                setStatus('文件夹创建失败 (网络错误)');
            });
        }

        // 重命名文件或文件夹
        function renameItem() {
            if (!selectedFile) {
                alert('请先选择要重命名的文件或文件夹');
                return;
            }

            const newName = prompt('请输入新名称:', selectedFile);
            if (!newName || newName.trim() === '' || newName.trim() === selectedFile) {
                return;
            }

            const trimmedName = newName.trim();
            if (trimmedName.includes('/') || trimmedName.includes('\\')) {
                alert('名称不能包含 / 或 \\ 字符');
                return;
            }

            setStatus('正在重命名: ' + selectedFile + ' -> ' + trimmedName);

            // 构建旧路径和新路径
            const oldPath = currentPath === '/' ? '/' + selectedFile : currentPath + '/' + selectedFile;
            const newPath = currentPath === '/' ? '/' + trimmedName : currentPath + '/' + trimmedName;

            fetch('http://localhost:5000/api/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    oldPath: oldPath,
                    newPath: newPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('重命名成功: ' + selectedFile + ' -> ' + trimmedName);
                    selectedFile = null;
                    refreshList();
                } else {
                    setStatus('重命名失败: ' + data.message);
                }
            })
            .catch(error => {
                console.log('重命名失败:', error);
                setStatus('重命名失败 (网络错误)');
            });
        }

        // 删除文件或文件夹
        function deleteItem() {
            if (!selectedFile) {
                alert('请先选择要删除的文件或文件夹');
                return;
            }

            if (!confirm(`确定要删除 "${selectedFile}" 吗？`)) {
                return;
            }

            setStatus('正在删除: ' + selectedFile);

            const itemPath = currentPath === '/' ? '/' + selectedFile : currentPath + '/' + selectedFile;

            fetch('http://localhost:5000/api/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    path: itemPath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setStatus('删除成功: ' + selectedFile);
                    selectedFile = null;
                    refreshList();
                } else {
                    setStatus('删除失败: ' + data.message);
                }
            })
            .catch(error => {
                console.log('删除失败:', error);
                setStatus('删除失败 (网络错误)');
            });
        }
        
        // 启用按钮
        function enableButtons() {
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('batchUploadBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('batchDownloadBtn').disabled = false;
            document.getElementById('deleteBtn').disabled = false;
            document.getElementById('createFolderBtn').disabled = false;
            document.getElementById('renameBtn').disabled = false;
            document.getElementById('refreshBtn').disabled = false;
            document.getElementById('selectAllBtn').disabled = false;
            document.getElementById('clearSelectionBtn').disabled = false;
            updateNavigationButtons();
        }

        // 更新导航按钮状态
        function updateNavigationButtons() {
            document.getElementById('backBtn').disabled = currentPath === '/';
        }

        // 更新路径显示
        function updatePathDisplay() {
            document.getElementById('currentPathDisplay').textContent = currentPath;
            document.getElementById('uploadPathDisplay').textContent = currentPath;
            updateNavigationButtons();
        }
        
        // 设置状态文本
        function setStatus(text) {
            document.getElementById('statusText').textContent = text;
        }
        
        // 设置进度条
        function setProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        // 切换文件选择状态
        function toggleFileSelection(filename, isSelected) {
            if (isSelected) {
                selectedFiles.add(filename);
            } else {
                selectedFiles.delete(filename);
            }
            updateSelectionStatus();
        }

        // 全选文件
        function selectAll() {
            const checkboxes = document.querySelectorAll('#fileTableBody input[type="checkbox"]:not([disabled])');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const filename = checkbox.getAttribute('onchange').match(/'([^']+)'/)[1];
                selectedFiles.add(filename);
            });
            updateSelectionStatus();
        }

        // 取消所有选择
        function clearSelection() {
            const checkboxes = document.querySelectorAll('#fileTableBody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedFiles.clear();
            updateSelectionStatus();
        }

        // 更新选择状态显示
        function updateSelectionStatus() {
            const count = selectedFiles.size;
            if (count > 0) {
                setStatus(`已选择 ${count} 个文件`);
                document.getElementById('batchDownloadBtn').style.background = '#28a745';
                document.getElementById('batchDownloadBtn').textContent = `📦 批量下载 (${count})`;
            } else {
                document.getElementById('batchDownloadBtn').style.background = '#6c757d';
                document.getElementById('batchDownloadBtn').textContent = '📦 批量下载';
            }
        }

        // 批量下载选中的文件
        function downloadSelected() {
            if (selectedFiles.size === 0) {
                alert('请先选择要下载的文件');
                return;
            }

            if (selectedFiles.size === 1) {
                // 如果只选择了一个文件，直接下载
                const filename = Array.from(selectedFiles)[0];
                downloadSingleFile(filename);
                return;
            }

            setStatus(`正在打包下载 ${selectedFiles.size} 个文件...`);
            setProgress(0);

            // 构建文件路径列表
            const filePaths = Array.from(selectedFiles).map(filename => {
                return currentPath === '/' ? '/' + filename : currentPath + '/' + filename;
            });

            // 发送批量下载请求
            fetch('http://localhost:5000/api/batch-download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    filePaths: filePaths,
                    zipName: `files_${new Date().getTime()}.zip`
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '批量下载失败');
                    });
                }
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `selected_files_${new Date().getTime()}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                setStatus(`批量下载完成: ${selectedFiles.size} 个文件`);
                setProgress(100);
                setTimeout(() => setProgress(0), 2000);

                // 清除选择
                clearSelection();
            })
            .catch(error => {
                console.log('批量下载失败:', error);
                setStatus('批量下载失败: ' + error.message);
                setProgress(0);
            });
        }

        // 下载单个文件（从原有函数中提取）
        function downloadSingleFile(filename) {
            setStatus('正在下载文件: ' + filename);
            setProgress(0);

            // 构建文件路径
            const filePath = currentPath === '/' ? '/' + filename : currentPath + '/' + filename;

            // 创建下载请求
            fetch('http://localhost:5000/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: currentUser,
                    filePath: filePath
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || '下载失败');
                    });
                }
            })
            .then(blob => {
                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                setStatus('文件下载完成: ' + filename);
                setProgress(100);
                setTimeout(() => setProgress(0), 2000);
            })
            .catch(error => {
                console.log('下载失败:', error);
                setStatus('下载失败: ' + error.message);
                setProgress(0);
            });
        }
        
        // 批量上传功能
        function batchUpload() {
            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }

            // 创建文件选择器，支持多选
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;  // 支持多选
            input.accept = '*/*';   // 接受所有文件类型

            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    addFilesToQueue(files);
                }
            };

            input.click();
        }

        // 添加文件到上传队列
        function addFilesToQueue(files) {
            files.forEach((file, index) => {
                const queueItem = {
                    id: Date.now() + index,
                    file: file,
                    status: 'waiting',  // waiting, uploading, completed, failed, paused
                    progress: 0,
                    error: null
                };
                uploadQueue.push(queueItem);
            });

            updateQueueDisplay();
            showUploadQueue();

            // 如果没有正在上传，开始上传
            if (!isUploading) {
                startBatchUpload();
            }
        }

        // 显示上传队列
        function showUploadQueue() {
            document.getElementById('uploadQueueContainer').style.display = 'block';
        }

        // 隐藏上传队列
        function hideUploadQueue() {
            document.getElementById('uploadQueueContainer').style.display = 'none';
        }

        // 更新队列显示
        function updateQueueDisplay() {
            const queueContainer = document.getElementById('uploadQueue');
            queueContainer.innerHTML = '';

            if (uploadQueue.length === 0) {
                queueContainer.innerHTML = '<p style="color: #6c757d;">队列为空</p>';
                return;
            }

            uploadQueue.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'margin: 10px 0; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; background: white;';

                const statusIcon = getStatusIcon(item.status);
                const statusColor = getStatusColor(item.status);

                itemDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${item.file.name}</strong>
                            <span style="color: #6c757d; margin-left: 10px;">(${formatFileSize(item.file.size)})</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <span style="color: ${statusColor}; margin-right: 10px;">${statusIcon} ${getStatusText(item.status)}</span>
                            ${item.status === 'waiting' || item.status === 'failed' ?
                                `<button class="btn btn-danger" onclick="removeFromQueue(${item.id})" style="padding: 2px 8px; font-size: 12px;">移除</button>` :
                                ''
                            }
                        </div>
                    </div>
                    ${item.status === 'uploading' ?
                        `<div style="margin-top: 5px;">
                            <div style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; background: #007bff; width: ${item.progress}%; transition: width 0.3s;"></div>
                            </div>
                            <small style="color: #6c757d;">${item.progress}%</small>
                        </div>` :
                        ''
                    }
                    ${item.error ? `<div style="color: #dc3545; font-size: 12px; margin-top: 5px;">错误: ${item.error}</div>` : ''}
                `;

                queueContainer.appendChild(itemDiv);
            });

            updateQueueStatus();
        }

        // 获取状态图标
        function getStatusIcon(status) {
            switch(status) {
                case 'waiting': return '⏳';
                case 'uploading': return '📤';
                case 'completed': return '✅';
                case 'failed': return '❌';
                case 'paused': return '⏸️';
                default: return '❓';
            }
        }

        // 获取状态颜色
        function getStatusColor(status) {
            switch(status) {
                case 'waiting': return '#6c757d';
                case 'uploading': return '#007bff';
                case 'completed': return '#28a745';
                case 'failed': return '#dc3545';
                case 'paused': return '#ffc107';
                default: return '#6c757d';
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            switch(status) {
                case 'waiting': return '等待中';
                case 'uploading': return '上传中';
                case 'completed': return '已完成';
                case 'failed': return '失败';
                case 'paused': return '已暂停';
                default: return '未知';
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 更新队列状态
        function updateQueueStatus() {
            const total = uploadQueue.length;
            const completed = uploadQueue.filter(item => item.status === 'completed').length;
            const failed = uploadQueue.filter(item => item.status === 'failed').length;
            const uploading = uploadQueue.filter(item => item.status === 'uploading').length;

            const statusText = `总计: ${total} | 已完成: ${completed} | 失败: ${failed} | 上传中: ${uploading}`;
            document.getElementById('queueStatus').textContent = statusText;

            // 更新按钮状态
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');

            if (isUploading && !isPaused) {
                pauseBtn.style.display = 'inline-block';
                resumeBtn.style.display = 'none';
            } else if (isPaused) {
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'inline-block';
            } else {
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
            }
        }

        // 从队列中移除文件
        function removeFromQueue(itemId) {
            uploadQueue = uploadQueue.filter(item => item.id !== itemId);
            updateQueueDisplay();

            if (uploadQueue.length === 0) {
                hideUploadQueue();
                isUploading = false;
                isPaused = false;
                currentUploadIndex = 0;
            }
        }

        // 清空上传队列
        function clearUploadQueue() {
            if (isUploading && !isPaused) {
                if (!confirm('正在上传中，确定要清空队列吗？')) {
                    return;
                }
            }

            uploadQueue = [];
            isUploading = false;
            isPaused = false;
            currentUploadIndex = 0;
            updateQueueDisplay();
            hideUploadQueue();
            setStatus('上传队列已清空');
        }

        // 暂停上传
        function pauseUpload() {
            isPaused = true;
            updateQueueDisplay();
            setStatus('上传已暂停');
        }

        // 继续上传
        function resumeUpload() {
            isPaused = false;
            updateQueueDisplay();
            setStatus('上传已继续');

            if (!isUploading) {
                startBatchUpload();
            }
        }

        // 开始批量上传
        function startBatchUpload() {
            if (uploadQueue.length === 0 || isPaused) {
                return;
            }

            isUploading = true;
            updateQueueDisplay();

            // 找到下一个等待上传的文件
            const nextItem = uploadQueue.find(item => item.status === 'waiting');
            if (!nextItem) {
                // 没有等待上传的文件，上传完成
                isUploading = false;
                setStatus('批量上传完成');
                updateQueueDisplay();

                // 检查是否所有文件都上传完成
                const allCompleted = uploadQueue.every(item => item.status === 'completed' || item.status === 'failed');
                if (allCompleted) {
                    setTimeout(() => {
                        refreshList();
                    }, 1000);
                }
                return;
            }

            // 开始上传当前文件
            uploadSingleFileFromQueue(nextItem);
        }

        // 从队列上传单个文件
        function uploadSingleFileFromQueue(queueItem) {
            if (isPaused) {
                return;
            }

            queueItem.status = 'uploading';
            queueItem.progress = 0;
            updateQueueDisplay();

            setStatus(`正在上传: ${queueItem.file.name}`);

            // 创建FormData对象
            const formData = new FormData();
            formData.append('file', queueItem.file);
            formData.append('username', currentUser);
            formData.append('path', currentPath);

            // 发送上传请求
            fetch('http://localhost:5000/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    queueItem.status = 'completed';
                    queueItem.progress = 100;
                    setStatus(`上传成功: ${queueItem.file.name}`);
                } else {
                    queueItem.status = 'failed';
                    queueItem.error = data.message;
                    setStatus(`上传失败: ${queueItem.file.name}`);
                }

                updateQueueDisplay();

                // 继续上传下一个文件
                setTimeout(() => {
                    startBatchUpload();
                }, 500);
            })
            .catch(error => {
                console.log('上传失败:', error);
                queueItem.status = 'failed';
                queueItem.error = error.message;
                updateQueueDisplay();

                // 继续上传下一个文件
                setTimeout(() => {
                    startBatchUpload();
                }, 500);
            });
        }

        // 拖拽上传功能
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            if (!isLoggedIn) {
                alert('请先登录');
                return;
            }
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                if (files.length === 1) {
                    // 单个文件直接上传
                    uploadFileToServer(files[0]);
                } else {
                    // 多个文件添加到批量上传队列
                    addFilesToQueue(files);
                }
            }
        });
    </script>
</body>
</html>
