#!/usr/bin/env python3
"""
Webæ¡¥æ¥æœåŠ¡å™¨ - è¿æ¥Webç•Œé¢å’ŒCæœåŠ¡å™¨
"""

from flask import Flask, request, jsonify, send_from_directory, Response
from flask_cors import CORS
import socket
import struct
import os
import hashlib
import zipfile
import io
import tempfile

app = Flask(__name__)
CORS(app)  # å…è®¸è·¨åŸŸè¯·æ±‚

# CæœåŠ¡å™¨é…ç½®
C_SERVER_HOST = '127.0.0.1'
C_SERVER_PORT = 9000

def connect_to_c_server():
    """è¿æ¥åˆ°CæœåŠ¡å™¨"""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.connect((C_SERVER_HOST, C_SERVER_PORT))
        return sock
    except Exception as e:
        print(f"è¿æ¥CæœåŠ¡å™¨å¤±è´¥: {e}")
        return None

def send_string(sock, data):
    """å‘é€å­—ç¬¦ä¸²åˆ°CæœåŠ¡å™¨"""
    data_bytes = data.encode('utf-8')
    length = len(data_bytes)
    print(f"[DEBUG] å‘é€å­—ç¬¦ä¸²: '{data}' (é•¿åº¦: {length})")
    sock.send(struct.pack('!I', length))  # å‘é€é•¿åº¦ï¼ˆç½‘ç»œå­—èŠ‚åºï¼‰
    sock.send(data_bytes)  # å‘é€æ•°æ®

def recv_response(sock):
    """æ¥æ”¶CæœåŠ¡å™¨å“åº”"""
    try:
        response = sock.recv(1)
        return response[0] if response else 0
    except:
        return 0

@app.route('/')
def index():
    """ä¸»é¡µ - è¿”å›ç™»å½•é¡µé¢"""
    return send_from_directory('.', 'login.html')

@app.route('/login.html')
def login_page():
    """ç™»å½•é¡µé¢"""
    return send_from_directory('.', 'login.html')

@app.route('/dashboard.html')
def dashboard_page():
    """ä¸»åŠŸèƒ½ç•Œé¢"""
    return send_from_directory('.', 'dashboard.html')

@app.route('/web_client.html')
def old_client():
    """æ—§ç‰ˆå®¢æˆ·ç«¯ï¼ˆå…¼å®¹æ€§ï¼‰"""
    return send_from_directory('.', 'web_client.html')

@app.route('/api/login', methods=['POST'])
def login():
    """ç”¨æˆ·ç™»å½•API"""
    data = request.json
    username = data.get('username', '')
    password = data.get('password', '')
    
    if not username or not password:
        return jsonify({'success': False, 'message': 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'})
    
    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})
    
    try:
        # å‘é€ç™»å½•å‘½ä»¤
        sock.send(b'L')
        
        # å‘é€ç”¨æˆ·å
        send_string(sock, username)
        
        # å‘é€å¯†ç 
        send_string(sock, password)
        
        # æ¥æ”¶å“åº”
        result = recv_response(sock)
        
        if result == 1:
            return jsonify({'success': True, 'message': 'ç™»å½•æˆåŠŸ'})
        else:
            return jsonify({'success': False, 'message': 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'})
            
    except Exception as e:
        return jsonify({'success': False, 'message': f'ç™»å½•å¤±è´¥: {str(e)}'})
    finally:
        sock.close()

@app.route('/api/register', methods=['POST'])
def register():
    """ç”¨æˆ·æ³¨å†ŒAPI"""
    data = request.json
    username = data.get('username', '')
    password = data.get('password', '')
    
    if not username or not password:
        return jsonify({'success': False, 'message': 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'})
    
    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})
    
    try:
        # å‘é€æ³¨å†Œå‘½ä»¤
        sock.send(b'R')
        
        # å‘é€ç”¨æˆ·å
        send_string(sock, username)
        
        # å‘é€å¯†ç 
        send_string(sock, password)
        
        # æ¥æ”¶å“åº”
        result = recv_response(sock)
        
        if result == 1:
            return jsonify({'success': True, 'message': 'æ³¨å†ŒæˆåŠŸ'})
        else:
            return jsonify({'success': False, 'message': 'æ³¨å†Œå¤±è´¥ï¼Œç”¨æˆ·åå¯èƒ½å·²å­˜åœ¨'})
            
    except Exception as e:
        return jsonify({'success': False, 'message': f'æ³¨å†Œå¤±è´¥: {str(e)}'})
    finally:
        sock.close()

@app.route('/api/files', methods=['GET'])
def list_files():
    """è·å–æ–‡ä»¶åˆ—è¡¨API"""
    username = request.args.get('username', '')
    path = request.args.get('path', '/')

    if not username:
        return jsonify({'success': False, 'message': 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º'})
    
    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})
    
    try:
        print(f"[DEBUG] è·å–æ–‡ä»¶åˆ—è¡¨: ç”¨æˆ·={username}, è·¯å¾„={path}")

        # å‘é€ç›®å½•åˆ—è¡¨å‘½ä»¤
        sock.send(b'S')

        # å‘é€ç”¨æˆ·å
        send_string(sock, username)

        # å‘é€ç›®æ ‡è·¯å¾„ (ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ ¹ç›®å½•)
        target_path = "" if path == "/" else path
        send_string(sock, target_path)

        # æ¥æ”¶å“åº”
        result = recv_response(sock)
        print(f"[DEBUG] æœåŠ¡å™¨å“åº”: {result}")
        
        if result == 1:
            # æ¥æ”¶æ¡ç›®æ•°é‡
            count_data = sock.recv(4)
            print(f"[DEBUG] æ¥æ”¶åˆ°æ¡ç›®æ•°é‡æ•°æ®: {len(count_data)} å­—èŠ‚")
            if len(count_data) == 4:
                item_count = struct.unpack('!I', count_data)[0]
                print(f"[DEBUG] æ¡ç›®æ•°é‡: {item_count}")

                files = []
                for i in range(item_count):
                    print(f"[DEBUG] å¤„ç†ç¬¬ {i+1} ä¸ªæ¡ç›®")

                    # æ¥æ”¶ç±»å‹ (1=æ–‡ä»¶, 2=ç›®å½•)
                    type_data = sock.recv(1)
                    if len(type_data) == 1:
                        item_type = type_data[0]
                        print(f"[DEBUG] æ¡ç›®ç±»å‹: {item_type}")

                        # æ¥æ”¶åç§°é•¿åº¦
                        name_len_data = sock.recv(4)
                        if len(name_len_data) == 4:
                            name_len = struct.unpack('!I', name_len_data)[0]
                            print(f"[DEBUG] åç§°é•¿åº¦: {name_len}")

                            # æ¥æ”¶åç§°
                            name = sock.recv(name_len).decode('utf-8')
                            print(f"[DEBUG] åç§°: {name}")

                            # æ¥æ”¶æ–‡ä»¶å¤§å° (big endian 64-bit)
                            size_data = sock.recv(8)
                            size = struct.unpack('>Q', size_data)[0] if len(size_data) == 8 else 0
                            print(f"[DEBUG] å¤§å°: {size}")

                            # æ¥æ”¶ä¿®æ”¹æ—¶é—´ (big endian 64-bit)
                            time_data = sock.recv(8)
                            mtime = struct.unpack('>Q', time_data)[0] if len(time_data) == 8 else 0
                            print(f"[DEBUG] ä¿®æ”¹æ—¶é—´: {mtime}")

                            files.append({
                                'name': name,
                                'type': 'directory' if item_type == 2 else 'file',
                                'size': size,
                                'mtime': mtime
                            })
                        else:
                            print(f"[ERROR] åç§°é•¿åº¦æ•°æ®ä¸å®Œæ•´: {len(name_len_data)} å­—èŠ‚")
                            break
                    else:
                        print(f"[ERROR] ç±»å‹æ•°æ®ä¸å®Œæ•´: {len(type_data)} å­—èŠ‚")
                        break

                print(f"[DEBUG] æˆåŠŸè§£æ {len(files)} ä¸ªæ–‡ä»¶")
                return jsonify({'success': True, 'files': files})
            else:
                print(f"[ERROR] æ¡ç›®æ•°é‡æ•°æ®ä¸å®Œæ•´: {len(count_data)} å­—èŠ‚")
                return jsonify({'success': False, 'message': 'æ¥æ”¶æ–‡ä»¶åˆ—è¡¨å¤±è´¥'})
        else:
            print(f"[ERROR] æœåŠ¡å™¨è¿”å›å¤±è´¥å“åº”: {result}")
            return jsonify({'success': False, 'message': 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥'})

    except Exception as e:
        print(f"[ERROR] å¼‚å¸¸: {str(e)}")
        import traceback
        traceback.print_exc()
        return jsonify({'success': False, 'message': f'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: {str(e)}'})
    finally:
        sock.close()

@app.route('/api/mkdir', methods=['POST'])
def create_directory():
    """åˆ›å»ºç›®å½•API"""
    data = request.json
    username = data.get('username', '')
    path = data.get('path', '')

    if not username or not path:
        return jsonify({'success': False, 'message': 'ç”¨æˆ·åå’Œè·¯å¾„ä¸èƒ½ä¸ºç©º'})

    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})

    try:
        # å‘é€åˆ›å»ºç›®å½•å‘½ä»¤
        sock.send(b'M')

        # å‘é€ç”¨æˆ·å
        send_string(sock, username)

        # å‘é€ç›®å½•è·¯å¾„
        send_string(sock, path)

        # æ¥æ”¶å“åº”
        result = recv_response(sock)

        if result == 1:
            return jsonify({'success': True, 'message': 'ç›®å½•åˆ›å»ºæˆåŠŸ'})
        else:
            return jsonify({'success': False, 'message': 'ç›®å½•åˆ›å»ºå¤±è´¥'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'ç›®å½•åˆ›å»ºå¤±è´¥: {str(e)}'})
    finally:
        sock.close()

@app.route('/api/delete', methods=['POST'])
def delete_item():
    """åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•API"""
    data = request.json
    username = data.get('username', '')
    path = data.get('path', '')

    if not username or not path:
        return jsonify({'success': False, 'message': 'ç”¨æˆ·åå’Œè·¯å¾„ä¸èƒ½ä¸ºç©º'})

    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})

    try:
        # å‘é€åˆ é™¤å‘½ä»¤
        sock.send(b'X')

        # å‘é€ç”¨æˆ·å
        send_string(sock, username)

        # å‘é€æ–‡ä»¶è·¯å¾„
        send_string(sock, path)

        # æ¥æ”¶å“åº”
        result = recv_response(sock)

        if result == 1:
            return jsonify({'success': True, 'message': 'åˆ é™¤æˆåŠŸ'})
        else:
            return jsonify({'success': False, 'message': 'åˆ é™¤å¤±è´¥'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'åˆ é™¤å¤±è´¥: {str(e)}'})
    finally:
        sock.close()

@app.route('/api/rename', methods=['POST'])
def rename_item():
    """é‡å‘½åæ–‡ä»¶æˆ–ç›®å½•API"""
    data = request.json
    username = data.get('username', '')
    old_path = data.get('oldPath', '')
    new_path = data.get('newPath', '')

    if not username or not old_path or not new_path:
        return jsonify({'success': False, 'message': 'å‚æ•°ä¸å®Œæ•´'})

    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})

    try:
        print(f"[DEBUG] é‡å‘½åè¯·æ±‚: ç”¨æˆ·={username}, æ—§è·¯å¾„={old_path}, æ–°è·¯å¾„={new_path}")

        # å‘é€é‡å‘½åå‘½ä»¤
        sock.send(b'N')

        # å‘é€ç”¨æˆ·å
        send_string(sock, username)

        # å‘é€æ—§è·¯å¾„
        send_string(sock, old_path)

        # å‘é€æ–°è·¯å¾„
        send_string(sock, new_path)

        # æ¥æ”¶å“åº”
        result = recv_response(sock)
        print(f"[DEBUG] é‡å‘½åå“åº”: {result}")

        if result == 1:
            return jsonify({'success': True, 'message': 'é‡å‘½åæˆåŠŸ'})
        else:
            return jsonify({'success': False, 'message': 'é‡å‘½åå¤±è´¥'})

    except Exception as e:
        return jsonify({'success': False, 'message': f'é‡å‘½åå¤±è´¥: {str(e)}'})
    finally:
        sock.close()

@app.route('/api/download', methods=['POST'])
def download_file():
    """æ–‡ä»¶ä¸‹è½½API"""
    data = request.json
    username = data.get('username', '')
    file_path = data.get('filePath', '')

    if not username or not file_path:
        return jsonify({'success': False, 'message': 'å‚æ•°ä¸å®Œæ•´'})

    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})

    try:
        # å‘é€ä¸‹è½½å‘½ä»¤
        sock.send(b'D')

        # å‘é€ç”¨æˆ·å
        send_string(sock, username)

        # å‘é€æ–‡ä»¶åï¼ˆä»è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼‰
        filename = file_path.split('/')[-1]
        send_string(sock, filename)

        # æ¥æ”¶æ–‡ä»¶å­˜åœ¨æ ‡å¿—
        flag_data = sock.recv(1)
        if len(flag_data) != 1 or flag_data[0] == 0:
            return jsonify({'success': False, 'message': 'æ–‡ä»¶ä¸å­˜åœ¨'})

        # æ¥æ”¶æ–‡ä»¶å¤§å°
        size_high_data = sock.recv(4)
        size_low_data = sock.recv(4)
        size_high = struct.unpack('!I', size_high_data)[0]
        size_low = struct.unpack('!I', size_low_data)[0]
        file_size = (size_high << 32) | size_low

        # æ¥æ”¶æ–‡ä»¶å†…å®¹
        file_content = b''
        bytes_received = 0
        while bytes_received < file_size:
            chunk = sock.recv(min(4096, file_size - bytes_received))
            if not chunk:
                break
            file_content += chunk
            bytes_received += len(chunk)

        # è¿”å›æ–‡ä»¶å†…å®¹
        return Response(
            file_content,
            mimetype='application/octet-stream',
            headers={
                'Content-Disposition': f'attachment; filename="{filename}"',
                'Content-Length': str(file_size)
            }
        )

    except Exception as e:
        return jsonify({'success': False, 'message': f'ä¸‹è½½å¤±è´¥: {str(e)}'})
    finally:
        sock.close()

@app.route('/api/batch-download', methods=['POST'])
def batch_download():
    """æ‰¹é‡ä¸‹è½½æ–‡ä»¶API"""
    data = request.json
    username = data.get('username', '')
    file_paths = data.get('filePaths', [])
    zip_name = data.get('zipName', 'files.zip')

    if not username or not file_paths:
        return jsonify({'success': False, 'message': 'å‚æ•°ä¸å®Œæ•´'})

    print(f"[DEBUG] æ‰¹é‡ä¸‹è½½è¯·æ±‚: ç”¨æˆ·={username}, æ–‡ä»¶æ•°é‡={len(file_paths)}")

    try:
        # åˆ›å»ºå†…å­˜ä¸­çš„ZIPæ–‡ä»¶
        zip_buffer = io.BytesIO()

        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
            for file_path in file_paths:
                try:
                    # è¿æ¥CæœåŠ¡å™¨ä¸‹è½½å•ä¸ªæ–‡ä»¶
                    sock = connect_to_c_server()
                    if not sock:
                        continue

                    # å‘é€ä¸‹è½½å‘½ä»¤
                    sock.send(b'D')

                    # å‘é€ç”¨æˆ·å
                    send_string(sock, username)

                    # å‘é€æ–‡ä»¶åï¼ˆä»è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼‰
                    filename = file_path.split('/')[-1]
                    send_string(sock, filename)

                    # æ¥æ”¶æ–‡ä»¶å­˜åœ¨æ ‡å¿—
                    flag_data = sock.recv(1)
                    if len(flag_data) != 1 or flag_data[0] == 0:
                        print(f"[DEBUG] æ–‡ä»¶ä¸å­˜åœ¨: {filename}")
                        sock.close()
                        continue

                    # æ¥æ”¶æ–‡ä»¶å¤§å°
                    size_high_data = sock.recv(4)
                    size_low_data = sock.recv(4)
                    size_high = struct.unpack('!I', size_high_data)[0]
                    size_low = struct.unpack('!I', size_low_data)[0]
                    file_size = (size_high << 32) | size_low

                    # æ¥æ”¶æ–‡ä»¶å†…å®¹
                    file_content = b''
                    bytes_received = 0
                    while bytes_received < file_size:
                        chunk = sock.recv(min(4096, file_size - bytes_received))
                        if not chunk:
                            break
                        file_content += chunk
                        bytes_received += len(chunk)

                    # æ·»åŠ åˆ°ZIPæ–‡ä»¶
                    zip_file.writestr(filename, file_content)
                    print(f"[DEBUG] å·²æ·»åŠ åˆ°ZIP: {filename} ({file_size} å­—èŠ‚)")

                    sock.close()

                except Exception as e:
                    print(f"[DEBUG] ä¸‹è½½æ–‡ä»¶å¤±è´¥ {file_path}: {str(e)}")
                    continue

        # è·å–ZIPæ–‡ä»¶å†…å®¹
        zip_buffer.seek(0)
        zip_content = zip_buffer.getvalue()
        zip_buffer.close()

        if len(zip_content) == 0:
            return jsonify({'success': False, 'message': 'æ²¡æœ‰æˆåŠŸä¸‹è½½ä»»ä½•æ–‡ä»¶'})

        print(f"[DEBUG] ZIPæ–‡ä»¶åˆ›å»ºå®Œæˆï¼Œå¤§å°: {len(zip_content)} å­—èŠ‚")

        # è¿”å›ZIPæ–‡ä»¶
        return Response(
            zip_content,
            mimetype='application/zip',
            headers={
                'Content-Disposition': f'attachment; filename="{zip_name}"',
                'Content-Length': str(len(zip_content))
            }
        )

    except Exception as e:
        print(f"[DEBUG] æ‰¹é‡ä¸‹è½½å¤±è´¥: {str(e)}")
        return jsonify({'success': False, 'message': f'æ‰¹é‡ä¸‹è½½å¤±è´¥: {str(e)}'})

@app.route('/api/upload', methods=['POST'])
def upload_file():
    """æ–‡ä»¶ä¸Šä¼ API"""
    username = request.form.get('username', '')
    target_path = request.form.get('targetPath', '/')

    if not username:
        return jsonify({'success': False, 'message': 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º'})
    
    if 'file' not in request.files:
        return jsonify({'success': False, 'message': 'æ²¡æœ‰é€‰æ‹©æ–‡ä»¶'})
    
    file = request.files['file']
    if file.filename == '':
        return jsonify({'success': False, 'message': 'æ²¡æœ‰é€‰æ‹©æ–‡ä»¶'})
    
    # è¿æ¥CæœåŠ¡å™¨
    sock = connect_to_c_server()
    if not sock:
        return jsonify({'success': False, 'message': 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨'})
    
    try:
        # å‘é€ä¸Šä¼ å‘½ä»¤
        sock.send(b'U')

        # å‘é€ç”¨æˆ·å
        send_string(sock, username)

        # å‘é€ç›®æ ‡ç›®å½•
        send_string(sock, target_path if target_path != '/' else "")

        # å‘é€æ–‡ä»¶å
        send_string(sock, file.filename)

        # å‘é€æ–‡ä»¶å†…å®¹
        file.seek(0)  # ç¡®ä¿ä»æ–‡ä»¶å¼€å¤´è¯»å–
        while True:
            chunk = file.read(4096)
            if not chunk:
                break
            sock.send(chunk)

        return jsonify({'success': True, 'message': 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ'})
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'æ–‡ä»¶ä¸Šä¼ å¤±è´¥: {str(e)}'})
    finally:
        sock.close()

if __name__ == '__main__':
    print("ğŸŒ Webæ¡¥æ¥æœåŠ¡å™¨å¯åŠ¨ä¸­...")
    print("ğŸ“¡ è¿æ¥åˆ°CæœåŠ¡å™¨:", f"{C_SERVER_HOST}:{C_SERVER_PORT}")
    print("ğŸŒ Webç•Œé¢åœ°å€: http://localhost:5000")
    print("=" * 50)
    
    app.run(host='0.0.0.0', port=5000, debug=True)
